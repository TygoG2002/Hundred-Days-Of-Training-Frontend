<div class="habit-card @(Habit.TodayCompleted ? "completed" : "")"
     role="button"
     tabindex="0"
     @onclick="Open">

    <div class="habit-header">
        <h3>@Habit.Name</h3>

        @if (Habit.TodayCompleted)
        {
            <span class="habit-status done">✓</span>
        }
        else
        {
            <span class="habit-status pending">Today</span>
        }
    </div>

    @if (Habit.IsValueBased)
    {
        <div class="habit-progress">
            <div class="progress-bar">
                <div class="progress-fill"
                     style="width:@ProgressPercent%"></div>
            </div>

            <span class="progress-text">
                @Habit.TodayValue / @Habit.TargetValue
            </span>
        </div>
    }
    else
    {
        <div class="habit-binary-hint">
            Tap to mark done
        </div>
    }
</div>

@if (showModal)
{
    <HabitModal Habit="Habit"
                OnAddValue="HandleAddValue"
                OnComplete="HandleComplete"
                OnClose="Close" />

}
 

@code {
    [Parameter, EditorRequired]
    public HabitTodayDto Habit { get; set; } = default!;

    [Parameter]
    public EventCallback<int> OnAddValue { get; set; }

    [Parameter]
    public EventCallback OnComplete { get; set; }

    bool showModal;

    int ProgressPercent =>
        Habit.TargetValue is null or 0
            ? 0
            : Math.Min(100, Habit.TodayValue * 100 / Habit.TargetValue.Value);

    void Open()
    {
        if (Habit.TodayCompleted)
            return;

        showModal = true;
    }

    void Close() => showModal = false;

    async Task HandleAddValue(int amount)
    {
        await OnAddValue.InvokeAsync(amount);
        showModal = false;
    }

    async Task HandleComplete()
    {
        await OnComplete.InvokeAsync();
        showModal = false;
    }
}

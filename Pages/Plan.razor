@page "/plan/{PlanId:int}"
@using HundredDays.Components
@using HundredDays.Services
@inject WorkoutApi Api
@inject NavigationManager Nav

<div class="page-header">
    @if (IsLoading)
    {
        <h1 class="skeleton-text">Loading plan</h1>
    }
    else if (HasError)
    {
        <h1>Something went wrong</h1>
        <p>We couldn’t load this plan.</p>

        <button class="finish-button" @onclick="Retry">
            Retry
        </button>
    }
    else
    {
        <button class="back-button" @onclick="GoBack">
            ← Back
        </button>
        <h1>@CurrentPlan</h1>
        <p>@Description</p>
    }
</div>

@if (IsLoading)
{
    <div class="grid">
        @for (int i = 0; i < 6; i++)
        {
            <div class="card skeleton-line"></div>
        }
    </div>
}
else if (!HasError && Days != null)
{
    <div class="grid">
        @foreach (var day in Days)
        {
            <DayCard DayNumber="day.DayId"
                     PlanId="PlanId"
                     IsLocked="@(day.DayId > CurrentDay)"
                     IsCurrent="@(day.DayId == CurrentDay)"
                     completed="completed" />
        }
    </div>
}

@code {
    [Parameter] public int PlanId { get; set; }

    [SupplyParameterFromQuery]
    public int completed { get; set; }

    List<DayOverviewDto>? Days;
    string? CurrentPlan;
    string? Description;

    int CurrentDay;

    bool IsLoading = true;
    bool HasError = false;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    async Task Load()
    {
        try
        {
            IsLoading = true;
            HasError = false;

            Days = await Api.GetDays(PlanId);

            var plans = await Api.GetPlans();
            var plan = plans.FirstOrDefault(p => p.Id == PlanId);

            CurrentPlan = plan?.Name;
            Description = plan?.Description;

            CurrentDay = completed + 1;
        }
        catch
        {
            HasError = true;
        }
        finally
        {
            IsLoading = false;
        }
    }

    async Task Retry()
    {
        await Load();
    }

    void GoBack()
    {
        Nav.NavigateTo("/plans");
    }
}

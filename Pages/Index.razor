@page "/"
@inject WorkoutApi Api
@inject NavigationManager Nav

<h1 class="page-title">Your workouts</h1>
<p class="page-subtitle">Pick up where you left off</p>

@if (Plans == null)
{
    <div class="grid">
        @for (int i = 0; i < 3; i++)
        {
            <div class="card skeleton-line"></div>

        }
    </div>
}
else if (!Plans.Any())
{
    <p>No workout plans yet.</p>
}
else
{
    <div class="grid">
        @foreach (var plan in Plans)
        {
            <div class="card" @onclick="() => Go(plan.Id)">
                <h3>@plan.Name</h3>

                <div class="plan-progress-bar">
                    <div class="plan-progress-fill"
                         style="width:@GetProgressPercent(plan)%">
                    </div>
                </div>

                <p class="plan-progress">@GetProgressText(plan)</p>
                <p class="plan-cta">Continue →</p>
            </div>
        }
    </div>
}

@code {
    List<WorkoutPlanDto>? Plans;
    Dictionary<int, (int done, int total)> PlanProgress = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Plans = await Api.GetPlans();

            var planTasks = Plans.Select(async plan =>
            {
                var days = await Api.GetDays(plan.Id);

                var progressTasks = days
                    .Select(day => Api.GetDayProgress(plan.Id, day))
                    .ToList();

                var progressResults = await Task.WhenAll(progressTasks);

                int doneDays = progressResults
                    .Count(p => p.total > 0 && p.done == p.total);

                PlanProgress[plan.Id] = (doneDays, days.Count);
            });

            await Task.WhenAll(planTasks);
        }
        catch
        {
            Plans = new();
        }
    }

    string GetProgressText(WorkoutPlanDto plan)
    {
        if (!PlanProgress.TryGetValue(plan.Id, out var progress))
            return "Loading…";

        if (progress.total == 0)
            return "Not started yet";

        if (progress.done == progress.total)
            return "Completed 🎉";

        return $"{progress.done} / {progress.total} days completed";
    }

    int GetProgressPercent(WorkoutPlanDto plan)
    {
        if (!PlanProgress.TryGetValue(plan.Id, out var progress))
            return 0;

        if (progress.total == 0)
            return 0;

        return (int)((progress.done / (double)progress.total) * 100);
    }

    void Go(int id)
    {
        Nav.NavigateTo($"/plan/{id}");
    }
}

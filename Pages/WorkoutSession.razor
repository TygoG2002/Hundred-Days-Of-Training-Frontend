@layout WorkoutSessionLayout
@page "/workout-session/{SessionId:int}"
@inject WorkoutApi Api
@inject NavigationManager Nav

@using HundredDays.Components

@if (IsLoading)
{
    <div class="sets skeleton">
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
    </div>
}
else if (HasError || Session == null || CurrentExercise == null)
{
    <div class="error-state">
        <h3>Something went wrong</h3>
        <p>We couldn’t load this workout session.</p>

        <button class="finish-button" @onclick="Retry">
            Retry
        </button>
    </div>
}
else
{
    <div class="session-header">
        <button class="stop-button"
                title="Stop workout"
                @onclick="OpenStopConfirm">
            Stop workout
        </button>
    </div>

    <h1 class="page-title">@CurrentExercise.Name</h1>

    <p class="exercise-target muted">
        Target: @CurrentExercise.Sets × @CurrentExercise.TargetReps reps
    </p>

    <div class="progress-wrapper">
        <div class="progress-bar">
            <div class="progress-fill" style="width:@ProgressPercent%"></div>
        </div>
        <p class="progress-text">
            Exercise @(currentExerciseIndex + 1) of @Session.Exercises.Count
        </p>
    </div>

    <div class="sets">
        @foreach (var set in CurrentExercise.SetsData)
        {
            var isActive = IsActiveSet(set);

            <label class="set workout-set
                                  @(set.Completed ? "completed" : "")
                                  @(isActive ? "active" : "")">

                <div class="set-left">
                    <strong>Set @set.SetNumber</strong>

                    @if (set.LastReps != null)
                    {
                        <span class="muted">
                            Last: @set.LastReps × @set.LastWeight?.ToString("0.#") kg
                        </span>
                    }
                </div>

                <div class="set-inputs">
                    <input type="number"
                           placeholder="Reps"
                           min="0"
                           step="1"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           @bind-value="set.CurrentReps"
                           @bind-value:event="oninput"
                           disabled="@set.Completed"
                           autofocus="@isActive" />

                    <input type="number"
                           placeholder="kg"
                           min="0"
                           step="0.5"
                           inputmode="decimal"
                           @bind-value="set.CurrentWeight"
                           @bind-value:event="oninput"
                           disabled="@set.Completed" />

                </div>

                <input type="checkbox"
                       checked="@set.Completed"
                       @onchange="e => OnSetToggle(set, (bool)e.Value!)" />
            </label>
        }
    </div>

    <div class="exercise-navigation">
        <button class="nav-button"
                disabled="@(!CanGoPrevious)"
                @onclick="GoPrevious">
            Previous
        </button>

        @if (!IsLastExercise)
        {
            <button class="nav-button"
                    disabled="@(!CanGoNext)"
                    @onclick="GoNext">
                Next
            </button>
        }
        else
        {
            <button class="finish-button"
                    disabled="@(!CanFinishWorkout)"
                    @onclick="FinishWorkout">
                Finish workout
            </button>
        }
    </div>
}

@if (ShowStopConfirm)
{
    <div class="confirm-backdrop">
        <div class="confirm-modal">
            <h3>Stop workout?</h3>
            <p class="muted">
                Your progress will be lost.
            </p>

            <div class="confirm-actions">
                <button class="secondary" @onclick="CloseStopConfirm">
                    Cancel
                </button>

                <button class="danger" @onclick="ConfirmStopWorkout">
                    Stop workout
                </button>
            </div>
        </div>
    </div>
}

@if (ShowRest)
{
    <RestTImer @key="RestKey"
               Duration="@RestSeconds"
               OnFinished="OnRestFinished" />
}

@code {
    [Parameter] public int SessionId { get; set; }

    WorkoutSessionDetailsDto? Session;
    int currentExerciseIndex = 0;

    bool IsLoading = true;
    bool HasError = false;
    bool ShowStopConfirm = false;

    bool ShowRest = false;
    int RestKey = 0;
    int RestSeconds = 60;

    WorkoutSessionExerciseDto? CurrentExercise =>
        Session?.Exercises.ElementAtOrDefault(currentExerciseIndex);

    int ProgressPercent =>
        Session == null || Session.Exercises.Count == 0
            ? 0
            : (int)(((currentExerciseIndex + 1) /
                    (double)Session.Exercises.Count) * 100);

    bool IsLastExercise =>
        Session != null &&
        currentExerciseIndex == Session.Exercises.Count - 1;

    bool CanGoPrevious =>
        currentExerciseIndex > 0;

    bool CanGoNext =>
        Session != null &&
        currentExerciseIndex < Session.Exercises.Count - 1;

    bool CanFinishWorkout =>
        Session != null &&
        Session.Exercises
            .SelectMany(e => e.SetsData)
            .All(s => s.Completed);

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    async Task Load()
    {
        try
        {
            IsLoading = true;
            HasError = false;

            Session = await Api.GetWorkoutSession(SessionId);

            foreach (var exercise in Session.Exercises)
                foreach (var set in exercise.SetsData)
                    set.Completed = false;
        }
        catch
        {
            HasError = true;
            Session = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    async Task Retry() => await Load();

    bool IsActiveSet(WorkoutSessionSetDto set)
    {
        if (set.Completed || CurrentExercise == null)
            return false;

        return CurrentExercise.SetsData.FirstOrDefault(s => !s.Completed) == set;
    }

    void OnSetToggle(WorkoutSessionSetDto set, bool completed)
    {
        set.Completed = completed;
        if (!completed) return;

        RestSeconds = CurrentExercise!.TargetReps <= 5 ? 120 : 60;
        RestKey++;
        ShowRest = true;
    }

    Task OnRestFinished()
    {
        ShowRest = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    void GoPrevious()
    {
        if (CanGoPrevious)
            currentExerciseIndex--;
    }

    void GoNext()
    {
        if (CanGoNext)
            currentExerciseIndex++;
    }

    async Task FinishWorkout()
    {
        if (!CanFinishWorkout || Session == null)
            return;

        var payload = Session.Exercises.Select(e =>
            new FinishWorkoutSessionExerciseDto
            {
                WorkoutSessionExerciseId = e.TemplateExerciseId,
                Sets = e.SetsData.Select(s =>
                    new FinishWorkoutSessionSetDto
                    {
                        SetNumber = s.SetNumber,
                        Reps = s.CurrentReps,
                        WeightKg = s.CurrentWeight
                    }).ToList()
            }).ToList();

        await Api.FinishWorkoutSession(SessionId, payload);
        Nav.NavigateTo("/");
    }

    void OpenStopConfirm() => ShowStopConfirm = true;
    void CloseStopConfirm() => ShowStopConfirm = false;

    async Task ConfirmStopWorkout()
    {
        ShowStopConfirm = false;
        await Api.DeleteWorkoutSession(SessionId);
        Nav.NavigateTo("/");
    }
}

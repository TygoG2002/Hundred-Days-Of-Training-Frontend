@page "/plans"
@inject WorkoutApi Api
@inject NavigationManager Nav

<h1 class="page-title">Your workouts</h1>
<p class="page-subtitle">Pick up where you left off</p>

@if (IsLoading)
{
    <div class="grid">
        @for (int i = 0; i < 3; i++)
        {
            <div class="card skeleton-line"></div>
        }
    </div>
}
else if (HasError)
{
    <div class="error-state">
        <h3>Something went wrong</h3>
        <p>We couldn’t load your workout plans.</p>

        <button class="finish-button" @onclick="Retry">
            Retry
        </button>
    </div>
}
else if (!Plans!.Any())
{
    <p>No workout plans yet.</p>
}
else
{
    <div class="grid">
        @foreach (var plan in Plans!)
        {
            <div class="card" @onclick="() => Go(plan.Id)">
                <h3>@plan.Name</h3>

                <div class="plan-progress-bar">
                    <div class="plan-progress-fill"
                         style="width:@GetProgressPercent(plan)%">
                    </div>
                </div>

                <p class="plan-progress">
                    @GetProgressText(plan)
                </p>

                <p class="plan-cta">Continue →</p>
            </div>
        }
    </div>
}

@code {
    List<PlanOverviewDto>? Plans;

    bool IsLoading = true;
    bool HasError = false;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    async Task Load()
    {
        try
        {
            IsLoading = true;
            HasError = false;

            Plans = await Api.GetPlansOverview();
        }
        catch
        {
            HasError = true;
            Plans = new();
        }
        finally
        {
            IsLoading = false;
        }
    }

    async Task Retry()
    {
        await Load();
    }

    string GetProgressText(PlanOverviewDto plan)
    {
        if (plan.TotalDays == 0)
            return "Not started yet";

        if (plan.CompletedDays == plan.TotalDays)
            return "Completed 🎉";

        return $"{plan.CompletedDays} / {plan.TotalDays} days completed";
    }

    int GetProgressPercent(PlanOverviewDto plan)
    {
        if (plan.TotalDays == 0)
            return 0;

        return (int)((plan.CompletedDays / (double)plan.TotalDays) * 100);
    }

    void Go(int id)
    {
        var completedDays = Plans!.First(p => p.Id == id).CompletedDays;
        Nav.NavigateTo($"/plan/{id}?completed={completedDays}");
    }
}

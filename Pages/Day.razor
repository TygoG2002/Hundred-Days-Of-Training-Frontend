@page "/plan/{planId:int}/day/{day:int}"
@inject WorkoutApi Api
@inject NavigationManager Nav

<h1 class="page-title">Day @day</h1>

@if (Sets == null)
{
    <p>Loading…</p>
}
else
{
    <div class="progress-wrapper">
        <div class="progress-bar">
            <div class="progress-fill"
                 style="width:@ProgressPercent%"></div>
        </div>
        <p class="progress-text">@Completed / @Total completed</p>
    </div>

    <div class="sets">
        @foreach (var set in Sets)
        {
            <label class="set">
                <input type="checkbox"
                       checked="@set.Completed"
                       @onchange="e => OnToggle(set.Id, (bool)e.Value!)" />
                <span>@set.Reps reps</span>
            </label>
        }
    </div>

    @if (IsFinished)
    {
        <button class="finish-button" @onclick="GoBack">
            Finish day
        </button>
    }
}

@code {
    [Parameter] public int planId { get; set; }
    [Parameter] public int day { get; set; }

    List<WorkoutSetDto>? Sets;
    int Completed;
    int Total;

    int ProgressPercent =>
        Total == 0 ? 0 : (int)((Completed / (double)Total) * 100);

    bool IsFinished => Total > 0 && Completed == Total;

    protected override async Task OnInitializedAsync()
    {
        Sets = await Api.GetSets(planId, day);
        await LoadProgress();
    }

    async Task OnToggle(int setId, bool completed)
    {
        var set = Sets!.First(s => s.Id == setId);
        set.Completed = completed;

        await Api.UpdateSet(setId, completed);
        await LoadProgress();
    }

    async Task LoadProgress()
    {
        var p = await Api.GetDayProgress(planId, day);
        Completed = p.done;
        Total = p.total;
    }

    void GoBack()
    {
        Nav.NavigateTo($"/plan/{planId}");
    }
}

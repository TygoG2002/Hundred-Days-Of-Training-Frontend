@page "/plan/{planId:int}/day/{day:int}"
@inject WorkoutApi Api
@inject NavigationManager Nav
@inject IJSRuntime JS

<button class="back-button" @onclick="GoBack">
    ← Back
</button>

<h1 class="page-title">Day @day</h1>

@if (Sets == null)
{
    <div class="sets skeleton">
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
    </div>
}
else
{
    <div class="progress-wrapper">
        <div class="progress-bar">
            <div class="progress-fill"
                 style="width:@ProgressPercent%"></div>
        </div>
        <p class="progress-text">@FocusText</p>
    </div>

    <div class="sets">
        @foreach (var set in Sets)
        {
            <label class="set">
                <input type="checkbox"
                       checked="@set.Completed"
                       @onchange="e => OnToggle(set, (bool)e.Value!)" />

                <span>@set.Reps reps</span>
            </label>
        }
    </div>

    @if (IsFinished)
    {
        <button class="finish-button" @onclick="FinishDay">
            Finish day
        </button>
    }

    @if (RestSeconds > 0)
    {
        <div class="rest-timer">
            ⏱ Rest: @RestSeconds s
        </div>
    }
}

@code {
    [Parameter] public int planId { get; set; }
    [Parameter] public int day { get; set; }

    [SupplyParameterFromQuery]
    public int completed { get; set; }

    List<WorkoutSetDto>? Sets;

    int RestSeconds;
    CancellationTokenSource? RestCts;

    int Completed => Sets?.Count(s => s.Completed) ?? 0;
    int Total => Sets?.Count ?? 0;

    int ProgressPercent =>
        Total == 0 ? 0 : (int)((Completed / (double)Total) * 100);

    bool IsFinished => Completed == Total && Total > 0;

    string FocusText
    {
        get
        {
            if (Total == 0)
                return "";

            if (IsFinished)
                return "Done for today 🎉";

            var remaining = Total - Completed;

            return remaining switch
            {
                1 => "Last set 💪",
                2 => "Almost there 👊",
                _ => $"{remaining} sets left"
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Sets = await Api.GetSets(planId, day);
    }

    async Task OnToggle(WorkoutSetDto set, bool completed)
    {
        set.Completed = completed;

        if (completed)
            await StartRestTimer();
    }


    async Task StartRestTimer()
    {
        RestCts?.Cancel();
        RestCts = new();

        RestSeconds = 60;

        try
        {
            while (RestSeconds > 0)
            {
                await Task.Delay(1000, RestCts.Token);
                RestSeconds--;
                StateHasChanged();
            }

            await JS.InvokeVoidAsync("navigator.vibrate", 50);
        }
        catch
        {
            // cancelled
        }
    }

    void GoBack()
    {
        Nav.NavigateTo($"/plan/{planId}?completed={completed}");
    }

    async Task FinishDay()
    {
        await Api.CompleteDay(planId, day, true);

        Api.InvalidatePlan(planId);

        Nav.NavigateTo($"/plan/{planId}?completed={completed+1}");
    }

}

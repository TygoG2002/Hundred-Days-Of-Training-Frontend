@page "/plan/{planId:int}/day/{day:int}"
@inject WorkoutApi Api
@inject NavigationManager Nav

@using HundredDays.Components

<button class="back-button" @onclick="GoBack">
    ← Back to Dashboard
</button>

<h1 class="page-title">Day @day</h1>

@if (IsLoading)
{
    <div class="sets skeleton">
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
        <div class="set skeleton-line"></div>
    </div>
}
else if (HasError)
{
    <div class="error-state">
        <h3>Something went wrong</h3>
        <p>We couldn’t load today’s workout.</p>

        <button class="finish-button" @onclick="Retry">
            Retry
        </button>
    </div>
}
else
{
    <div class="progress-wrapper">
        <div class="progress-bar">
            <div class="progress-fill"
                 style="width:@ProgressPercent%"></div>
        </div>
        <p class="progress-text">@FocusText</p>
    </div>

    <div class="sets">
        @foreach (var set in Sets!)
        {
            <label class="set">
                <input type="checkbox"
                       checked="@set.Completed"
                       @onchange="e => OnToggle(set, (bool)e.Value!)" />
                <span>@set.Reps reps</span>
            </label>
        }
    </div>

    @if (IsFinished)
    {
        <button class="finish-button"
                disabled="@IsFinishing"
                @onclick="FinishDay">
            @if (IsFinishing)
            {
                <span>Finishing…</span>
            }
            else
            {
                <span>Finish day</span>
            }
        </button>
    }
}

@if (ShowRest)
{
    <RestTImer @key="RestKey"
               Duration="60"
               OnFinished="OnRestFinished" />
}

@code {
    [Parameter] public int planId { get; set; }
    [Parameter] public int day { get; set; }

    [SupplyParameterFromQuery]
    public int completed { get; set; }

    List<WorkoutSetDto>? Sets;

    bool IsLoading = true;
    bool HasError = false;

    bool ShowRest = false;
    int RestKey = 0;

    bool IsFinishing = false; // 👈 NEW

    int TotalReps => Sets?.Sum(s => s.Reps) ?? 0;
    int DoneReps => Sets?.Where(s => s.Completed).Sum(s => s.Reps) ?? 0;

    int ProgressPercent =>
        TotalReps == 0 ? 0 : (int)((DoneReps / (double)TotalReps) * 100);

    bool IsFinished =>
        TotalReps > 0 && DoneReps == TotalReps;

    string FocusText
    {
        get
        {
            if (TotalReps == 0)
                return "";

            if (IsFinished)
                return "Done for today 🎉";

            var remaining = TotalReps - DoneReps;

            return remaining switch
            {
                <= 5 => "Last set 💪",
                _ => $"{remaining} reps left"
            };
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    async Task Load()
    {
        try
        {
            IsLoading = true;
            HasError = false;

            Sets = await Api.GetSets(planId, day);

            foreach (var set in Sets)
                set.Completed = false;
        }
        catch
        {
            HasError = true;
            Sets = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    async Task Retry()
    {
        await Load();
    }

    async Task OnToggle(WorkoutSetDto set, bool completed)
    {
        set.Completed = completed;

        if (completed && !IsFinished)
        {
            RestKey++;
            ShowRest = true;
        }
    }

    Task OnRestFinished()
    {
        ShowRest = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    void GoBack()
    {
        Nav.NavigateTo("/");
    }

    async Task FinishDay()
    {
        if (IsFinishing)
            return;

        try
        {
            IsFinishing = true;

            await Api.CompleteDay(planId, day, true);
            Api.InvalidatePlan(planId);

            Nav.NavigateTo(
                $"/plan/{planId}?completed={completed + 1}");
        }
        finally
        {
            IsFinishing = false;
        }
    }
}
